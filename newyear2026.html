<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ„ Gizli YÄ±lbaÅŸÄ± Ã‡ekiliÅŸi ğŸ</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    
    <style>
        /* CSS Stil KodlarÄ± */
        body { 
            font-family: 'Arial', sans-serif; 
            text-align: center; 
            margin: 0; 
            padding: 20px;
            background-color: #f4f4f9; 
            color: #333; 
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container { 
            max-width: 400px; 
            width: 100%;
            margin: 0 auto; 
            padding: 30px; 
            border-radius: 15px; 
            background-color: #fff; 
            box-shadow: 0 8px 16px rgba(0,0,0,0.2); 
        }
        h1 { 
            color: #e74c3c; /* KÄ±rmÄ±zÄ± */
            margin-bottom: 25px;
            font-size: 28px;
        }
        p {
            margin-bottom: 20px;
        }
        select, button { 
            padding: 12px; 
            margin: 10px 0; 
            width: 100%; 
            box-sizing: border-box; 
            border-radius: 8px; 
            font-size: 16px;
        }
        select {
            border: 2px solid #bdc3c7;
            background-color: #ecf0f1;
        }
        button { 
            background-color: #2ecc71; /* YeÅŸil */
            color: white; 
            cursor: pointer; 
            border: none; 
            transition: background-color 0.3s;
        }
        button:hover:not(:disabled) { 
            background-color: #27ae60; 
        }
        button:disabled {
            background-color: #95a5a6; /* Gri */
            cursor: not-allowed;
        }
        #sonuc { 
            margin-top: 30px; 
            font-size: 26px; 
            font-weight: bold; 
            color: #2980b9; /* Mavi */
            padding: 15px; 
            background-color: #eaf4ff; 
            border-radius: 10px; 
            min-height: 30px;
        }
        .uyari { 
            color: #7f8c8d; 
            font-size: 12px; 
            margin-top: 20px; 
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>ğŸ Gizli YÄ±lbaÅŸÄ± Ã‡ekiliÅŸi </h1>
        <p>LÃ¼tfen listeden **kendi isminizi** seÃ§in:</p>
        
        <select id="kisiSecimi">
            </select>

        <button id="cekilisYapButon">Kimin Hediyesi OlacaÄŸÄ±m?</button>
        
        <div id="sonuc">SonuÃ§ yÃ¼kleniyor veya henÃ¼z Ã§ekiliÅŸ yapÄ±lmadÄ±...</div>

        <p class="uyari">SonuÃ§ sadece sizin cihazÄ±nÄ±zda ve veritabanÄ±nda gizli olarak saklanÄ±r. BaÅŸka kimse gÃ¶remez.</p>
    </div>

    <script>
        // ***************************************************************
        // *** 1. Ã–NEMLÄ°: FIREBASE KONFÄ°GÃœRASYONUNUZU BURAYA YAPIÅTIRIN ***
        // ***************************************************************
        const firebaseConfig = {
  apiKey: "AiZaSyACw0EuiKei-JPDnJcRXLWw-J9ntXoSFÄ°", 
  authDomain: "newyeargift-2ae9a.firebaseapp.com",
  projectId: "newyeargift-2ae9a",
  storageBucket: "newyeargift-2ae9a.appspot.com",
  messagingSenderId: "21487043286",
  appId: "1:21487043286:web:4ea67e4b27463c5b49ff77",
  measurementId: "G-58TDFPD5MH",
  // ğŸ’¥ SÄ°ZÄ°N EKSÄ°K OLAN DATABASE ADRESÄ°NÄ°Z
  databaseURL: "https://newyeargift-2ae9a-default-rtdb.europe-west1.firebaseapp.app" 
};
        
        // Firebase BaÅŸlatma
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const katilimcilarRef = database.ref('katilimcilar');

        // Sabit Ä°sim Listesi (Bu liste, Firebase'deki isimlerle aynÄ± olmalÄ±dÄ±r)
        const katilimcilar = [
            "Sueda", "Yaren", "Alican", "Åule", "Seher", 
            "Fatih", "Ä°lknur", "Tuncay", "Zeynep"
        ];
        
        const secimElementi = document.getElementById('kisiSecimi');
        const buton = document.getElementById('cekilisYapButon');
        const sonucDiv = document.getElementById('sonuc');

        // Ä°simleri SeÃ§im Kutusuna Ekle
        katilimcilar.forEach(isim => {
            const option = document.createElement('option');
            option.value = isim;
            option.textContent = isim;
            secimElementi.appendChild(option);
        });

        // Sayfa YÃ¼klendiÄŸinde veya Ä°sim DeÄŸiÅŸtiÄŸinde Sonucu Kontrol Et ve GÃ¶ster
        async function sonucKontrolVeGoster() {
            const secilenKisi = secimElementi.value;
            
            // 1. Yerel Depolamada (Local Storage) Sonucu Kontrol Et (Gizlilik ve HÄ±z iÃ§in)
            const cekilenIsimGizli = localStorage.getItem('cekilis_sonucu_' + secilenKisi);

            if (cekilenIsimGizli) {
                sonucDiv.textContent = `ğŸ‰ Ã‡ekiliÅŸ sonucun: ${cekilenIsimGizli}`;
                buton.disabled = true;
                return; // Yerel sonuÃ§ varsa, Firebase'e bakmaya gerek yok.
            } 
            
            // 2. Local Storage boÅŸsa, Firebase'i Kontrol Et (FarklÄ± cihazdan girme durumu)
            try {
                const snapshot = await katilimcilarRef.child(secilenKisi).once('value');
                const dbSonuc = snapshot.val();

                // EÄŸer Firebase'de kiÅŸinin sonucu varsa (Musait deÄŸilse ve Cekildi deÄŸilse)
                if (dbSonuc && dbSonuc !== "Musait" && dbSonuc !== "Cekildi") {
                    // Sonucu Local Storage'a kaydet (GizliliÄŸi korumak iÃ§in)
                    localStorage.setItem('cekilis_sonucu_' + secilenKisi, dbSonuc);
                    sonucDiv.textContent = `ğŸ‰ Ã‡ekiliÅŸ sonucun: ${dbSonuc} (BaÅŸka cihazda yapmÄ±ÅŸtÄ±nÄ±z)`;
                    buton.disabled = true;
                    return;
                }
            } catch (error) {
                console.error("Firebase kontrol hatasÄ±:", error);
                sonucDiv.textContent = 'VeritabanÄ± kontrol edilirken bir hata oluÅŸtu.';
                buton.disabled = true; // Butonu kilitle
                return;
            }

            // SonuÃ§ yoksa butonu aktif et
            sonucDiv.textContent = 'HazÄ±r olduÄŸunda "Kimin Hediyesi OlacaÄŸÄ±m?" butonuna tÄ±kla.';
            buton.disabled = false;
        }

        // Ã‡ekiliÅŸ Yapma Fonksiyonu (Benzersizlik Garantisi)
        async function cekilisYap() {
            const secilenKisi = secimElementi.value;
            
            if (localStorage.getItem('cekilis_sonucu_' + secilenKisi)) {
                sonucDiv.textContent = 'âŒ Zaten Ã§ekiliÅŸ yapÄ±lmÄ±ÅŸ. SayfayÄ± yenilemeden Ã¶nce sonucunuz: ' + localStorage.getItem('cekilis_sonucu_' + secilenKisi);
                return;
            }

            buton.disabled = true;
            sonucDiv.textContent = 'ÅanslÄ± ismi Ã§ekiyoruz... LÃ¼tfen bekleyin.';

            try {
                // TÃ¼m katilimcilar verisini Ã§ek
                const snapshot = await katilimcilarRef.once('value');
                const tumVeriler = snapshot.val();
                
                // MÃ¼sait olan isimleri bul
                let musaitler = [];
                for (const isim in tumVeriler) {
                    // 1. Kendi ismin deÄŸil
                    // 2. HenÃ¼z Ã§ekilmemiÅŸ (DeÄŸeri "Musait" olmalÄ±)
                    if (isim !== secilenKisi && tumVeriler[isim] === 'Musait') {
                        musaitler.push(isim);
                    }
                }

                if (musaitler.length === 0) {
                    sonucDiv.textContent = 'ÃœzgÃ¼nÃ¼m, Ã§ekiliÅŸ yapÄ±lacak mÃ¼sait isim kalmadÄ±. (TÃ¼m isimler Ã§ekilmiÅŸ olabilir.)';
                    buton.disabled = true;
                    return;
                }

                // Rastgele MÃ¼sait Ä°sim SeÃ§me
                const randomIndex = Math.floor(Math.random() * musaitler.length);
                const sansliIsim = musaitler[randomIndex];

                // 4. VeritabanÄ± Yazma Ä°ÅŸlemleri (Benzersizlik Garantisi iÃ§in Ã¶nce Ã§ekilenin durumunu deÄŸiÅŸtiririz)
                
                // Ä°lk olarak, hediye olarak Ã§Ä±kan ismin mÃ¼saitlik durumunu "Cekildi" olarak gÃ¼ncelle
                await katilimcilarRef.child(sansliIsim).set('Cekildi');
                
                // Ä°kinci olarak, Ã§ekiliÅŸi yapan kiÅŸinin sonucunu kaydet (Gizlilik iÃ§in)
                await katilimcilarRef.child(secilenKisi).set(sansliIsim);
                
                // Ä°ÅŸlem baÅŸarÄ±lÄ±: Sonucu sadece kullanÄ±cÄ±nÄ±n cihazÄ±na kaydet (Gizlilik)
                localStorage.setItem('cekilis_sonucu_' + secilenKisi, sansliIsim);
                
                sonucDiv.textContent = `ğŸ‰ TEBRÄ°KLER! Hediye alacaÄŸÄ±nÄ±z kiÅŸi: ${sansliIsim}`;
                buton.disabled = true;
                
            } catch (error) {
                console.error("Ã‡ekiliÅŸ hatasÄ±:", error);
                sonucDiv.textContent = 'Bir hata oluÅŸtu. LÃ¼tfen tekrar deneyin.';
                buton.disabled = false;
            }
        }

        // Olay Dinleyicileri
        buton.addEventListener('click', cekilisYap);
        secimElementi.addEventListener('change', sonucKontrolVeGoster);
        
        // Sayfa yÃ¼klendiÄŸinde sonucu kontrol et
        document.addEventListener('DOMContentLoaded', sonucKontrolVeGoster);

    </script>

</body>
</html>